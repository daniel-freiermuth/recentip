# GitLab CI/CD configuration for someip-runtime
#
# Stages:
# - test: Run test suite
# - build: Build release artifacts and cross-compile

stages:
  - test
  - build

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

# Cache cargo dependencies between jobs
.rust-cache: &rust-cache
  cache:
    key:
      files:
        - Cargo.lock
    paths:
      - .cargo/registry
      - .cargo/git
      - target/

# Base image for Rust jobs
.rust-base:
  image: rust:1.92
  <<: *rust-cache
  before_script:
    - rustup component add clippy rustfmt

# =============================================================================
# CHECK STAGE - Fast feedback
# =============================================================================

format:
  extends: .rust-base
  stage: test
  script:
    - cargo fmt --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

clippy:
  extends: .rust-base
  stage: test
  script:
    - cargo clippy --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# TEST STAGE
# =============================================================================

test:
  extends: .rust-base
  stage: test
  script:
    - cargo install cargo-llvm-cov cargo-nextest --locked
    - cargo +nightly llvm-cov nextest --no-fail-fast --all-features --branch --cobertura --output-path coverage.xml
    - cargo llvm-cov report --summary-only
  coverage: '/TOTAL.*\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

doc-test:
  extends: .rust-base
  stage: test
  script:
    - cargo test --doc
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

doc-build:
  extends: .rust-base
  stage: test
  before_script:
    - apt-get update && apt-get install -y python3
    - rustup component add clippy rustfmt
    - git submodule update --init
  script:
    - python3 tools/extract_requirements.py
    - python3 scripts/extract_coverage.py
    - cargo doc --no-deps
  artifacts:
    paths:
      - target/doc/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# BUILD STAGE
# =============================================================================

build-release:
  extends: .rust-base
  stage: build
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/libsomeip_runtime.*
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Cross-compile for QNX target
build-qnx:
  extends: .rust-base
  stage: build
  variables:
    QNX_TARGET: aarch64-unknown-nto-qnx710
  before_script:
    - rustup target add ${QNX_TARGET} || true
  script:
    # Check only - actual build requires QNX SDK
    - cargo check --target ${QNX_TARGET} --no-default-features 2>/dev/null || echo "QNX target not available (expected in CI without QNX SDK)"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# REQUIREMENT COVERAGE (spec requirements via covers!() annotations)
# =============================================================================

requirement-coverage:
  stage: test
  image: python:3.11
  before_script:
    - git submodule update --init
  script:
    - python tools/extract_requirements.py
    - python scripts/extract_coverage.py
    - python scripts/generate_compliance.py
    # Fail if requirement coverage drops (optional threshold)
    # - grep -oP 'Overall Coverage \| \K[0-9.]+' COVERAGE_REPORT.md | awk '{if ($1 < 15) exit 1}'
  artifacts:
    paths:
      - COVERAGE_REPORT.md
      - COMPLIANCE.md
      - spec-data/coverage.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

sonarcloud-check:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - main
    